<script>
const API_BASE = '/api';
let token = localStorage.getItem('token');
let currentCandidates = [];

// üîÑ Load dashboard data
async function loadDashboard() {
  try {
    if (!token) throw new Error('No token');
    
    // Load stats
    const stats = await fetchJSON('/hr/candidates/stats');
    document.getElementById('totalCount').textContent = stats.data.total || 0;
    
    // Load candidates
    await loadCandidates();
  } catch (err) {
    console.error('Dashboard load failed:', err);
    window.location.href = '/login.html';
  }
}

// üìã Load candidates table
async function loadCandidates(status = '', search = '') {
  try {
    const params = new URLSearchParams({ page: 0, size: 50 });
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    
    const response = await fetch(`${API_BASE}/hr/candidates?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) throw new Error('Failed to load candidates');
    
    const data = await response.json();
    currentCandidates = data.data.content || [];
    renderTable(currentCandidates);
  } catch (err) {
    console.error('Load candidates failed:', err);
    document.getElementById('candidatesTableBody').innerHTML = 
      '<tr><td colspan="7" class="text-center py-5 text-muted">Error loading data</td></tr>';
  }
}

// üñºÔ∏è Render table rows
function renderTable(candidates) {
  const tbody = document.getElementById('candidatesTableBody');
  
  if (!candidates.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">No candidates found</td></tr>';
    return;
  }
  
  tbody.innerHTML = candidates.map(c => `
    <tr>
      <td>${c.id}</td>
      <td>${c.employeeName || 'N/A'}</td>
      <td>${c.emailId || 'N/A'}</td>
      <td>${c.mobileNo || 'N/A'}</td>
      <td>
        <span class="badge ${
          c.joiningStatus === 'APPROVED' ? 'bg-success' :
          c.joiningStatus === 'REJECTED' ? 'bg-danger' :
          c.joiningStatus === 'INITIATED' ? 'bg-warning' : 'bg-secondary'
        }">${c.joiningStatus || 'N/A'}</span>
      </td>
      <td>${c.assignedHRName || 'N/A'}</td>
      <td>
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-primary view-btn" data-id="${c.id}">
            <i class="fas fa-eye"></i>
          </button>
          ${c.joiningStatus !== 'APPROVED' && c.joiningStatus !== 'REJECTED' ? 
            `<button class="btn btn-outline-success approve-btn" data-id="${c.id}">
               <i class="fas fa-check"></i>
             </button>` : ''
          }
          ${c.joiningStatus === 'INITIATED' ? 
            `<button class="btn btn-outline-info send-link-btn" data-id="${c.id}">
               <i class="fas fa-paper-plane"></i>
             </button>` : ''
          }
          <button class="btn btn-outline-danger reject-btn" data-id="${c.id}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
  
  // Add event listeners
  document.querySelectorAll('.approve-btn').forEach(btn => 
    btn.addEventListener('click', handleApprove));
  document.querySelectorAll('.reject-btn').forEach(btn => 
    btn.addEventListener('click', handleReject));
  document.querySelectorAll('.send-link-btn').forEach(btn => 
    btn.addEventListener('click', handleSendLink));
  document.querySelectorAll('.view-btn').forEach(btn => 
    btn.addEventListener('click', handleView));
}

// ‚ûï Create candidate
async function createCandidate() {
  const form = document.getElementById('createForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  data.sendLinkImmediately = formData.get('sendLinkImmediately') === 'on';
  
  try {
    const response = await fetch(`${API_BASE}/hr/candidates/initiate`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
      form.reset();
      loadCandidates();
      showToast('Candidate created successfully!', 'success');
    }
  } catch (err) {
    showToast('Failed to create candidate', 'error');
  }
}

// ‚úÖ Approve
async function handleApprove(e) {
  const id = e.target.closest('button').dataset.id;
  if (confirm('Approve this candidate?')) {
    try {
      await fetch(`${API_BASE}/hr/candidates/${id}/approve`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      loadCandidates();
      showToast('Candidate approved!', 'success');
    } catch (err) {
      showToast('Approve failed', 'error');
    }
  }
}

// ‚ùå Reject
async function handleReject(e) {
  const id = e.target.closest('button').dataset.id;
  const reason = prompt('Rejection reason:');
  if (reason) {
    try {
      await fetch(`${API_BASE}/hr/candidates/${id}/reject`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ rejectionReason: reason })
      });
      loadCandidates();
      showToast('Candidate rejected', 'success');
    } catch (err) {
      showToast('Reject failed', 'error');
    }
  }
}

// üì± Send link
async function handleSendLink(e) {
  const id = e.target.closest('button').dataset.id;
  try {
    await fetch(`${API_BASE}/hr/candidates/${id}/send-link`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    showToast('SMS link sent!', 'success');
  } catch (err) {
    showToast('Send link failed', 'error');
  }
}

// üëÅÔ∏è View details (placeholder)
function handleView(e) {
  const id = e.target.closest('button').dataset.id;
  alert(`View candidate ${id} details - implement modal here`);
}

// üîç Search/Filter
document.getElementById('searchInput').oninput = debounce(function() {
  loadCandidates(document.getElementById('statusFilter').value, this.value);
}, 300);

document.getElementById('statusFilter').onchange = function() {
  loadCandidates(this.value, document.getElementById('searchInput').value);
};

// ‚ûï Create button
document.getElementById('createBtn').onclick = () => {
  new bootstrap.Modal(document.getElementById('createModal')).show();
};

// üíæ Save button
document.getElementById('saveCandidate').onclick = createCandidate;

// üîî Toast notifications
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
  toast.role = 'alert';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.body.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// üîß Utility functions
function fetchJSON(url) {
  return fetch(url, { headers: { 'Authorization': `Bearer ${token}` } })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// üöÄ Auto-start
if (token) {
  loadDashboard();
} else {
  window.location.href = '/login.html';
}
</script>
