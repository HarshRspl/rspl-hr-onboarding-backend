<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RSPL HR â€“ Onboarding Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family:"Segoe UI",sans-serif; background:#f1f5f9; }
    .gbg  { background:linear-gradient(135deg,#1e3a5f 0%,#2563eb 100%); }
    .card { background:white; border-radius:14px; box-shadow:0 2px 14px rgba(0,0,0,.07); }
    .badge { display:inline-flex; align-items:center; padding:3px 10px; border-radius:999px; font-size:11px; font-weight:700; }
    .b-initiated      { background:#eff6ff; color:#2563eb; }
    .b-form_submitted { background:#f5f3ff; color:#7c3aed; }
    .b-signed         { background:#fefce8; color:#b45309; }
    .b-approved       { background:#f0fdf4; color:#16a34a; }
    .b-rejected       { background:#fef2f2; color:#dc2626; }
    .ifield { width:100%; border:1.5px solid #e2e8f0; border-radius:9px; padding:10px 13px; font-size:14px; outline:none; transition:border-color .2s,box-shadow .2s; }
    .ifield:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12); }
    .lbl { display:block; font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:.05em; margin-bottom:4px; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:50; align-items:center; justify-content:center; }
    .overlay.open { display:flex; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    .modal-box { animation:fadeUp .3s ease; }
    .tab-btn { padding:8px 18px; border-radius:8px; font-size:13px; font-weight:600; color:#64748b; cursor:pointer; transition:all .2s; }
    .tab-btn.active { background:#2563eb; color:white; }
    .tab-btn:not(.active):hover { background:#f1f5f9; }
    .action-btn { padding:5px 14px; border-radius:7px; font-size:12px; font-weight:700; cursor:pointer; transition:all .15s; border:none; }
    tr:hover td { background:#f8fafc; }
  </style>
  <script src="config.js"></script>
</head>
<body>

<nav class="gbg text-white px-6 py-3.5 flex items-center gap-4 shadow-lg sticky top-0 z-30">
  <div class="w-9 h-9 bg-white/20 rounded-xl flex items-center justify-center font-black text-xl">R</div>
  <div>
    <div class="font-bold text-base leading-tight">RSPL Health</div>
    <div class="text-xs text-blue-200">HR Onboarding Dashboard</div>
  </div>
  <div class="ml-auto flex items-center gap-4">
    <div class="hidden md:flex items-center gap-2 bg-white/10 rounded-xl px-4 py-2">
      <div class="w-7 h-7 bg-white/20 rounded-full flex items-center justify-center text-sm font-bold" id="user-avatar">?</div>
      <div>
        <p class="text-xs font-bold leading-tight" id="hr-user-name">Loadingâ€¦</p>
        <p class="text-xs text-blue-200 leading-tight" id="hr-user-role"></p>
      </div>
    </div>
    <button onclick="logout()"
            class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl text-sm font-semibold transition">
      ğŸšª Logout
    </button>
  </div>
</nav>

<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="card p-4 text-center">
      <p class="text-2xl font-black text-gray-800" id="stat-total">â€“</p>
      <p class="text-xs text-gray-500 font-semibold mt-1">Total</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-2xl font-black text-blue-600" id="stat-initiated">â€“</p>
      <p class="text-xs text-gray-500 font-semibold mt-1">Initiated</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-2xl font-black text-purple-600" id="stat-submitted">â€“</p>
      <p class="text-xs text-gray-500 font-semibold mt-1">Submitted</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-2xl font-black text-green-600" id="stat-approved">â€“</p>
      <p class="text-xs text-gray-500 font-semibold mt-1">Approved</p>
    </div>
    <div class="card p-4 text-center">
      <p class="text-2xl font-black text-red-500" id="stat-rejected">â€“</p>
      <p class="text-xs text-gray-500 font-semibold mt-1">Rejected</p>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="card px-5 py-4 mb-5 flex flex-col md:flex-row md:items-center gap-3">
    <div class="flex gap-1 flex-wrap" id="tab-bar">
      <button class="tab-btn active" data-status="" onclick="setTab(this,'')">All</button>
      <button class="tab-btn" data-status="INITIATED"      onclick="setTab(this,'INITIATED')">Initiated</button>
      <button class="tab-btn" data-status="FORM_SUBMITTED" onclick="setTab(this,'FORM_SUBMITTED')">Submitted</button>
      <button class="tab-btn" data-status="SIGNED"         onclick="setTab(this,'SIGNED')">Signed</button>
      <button class="tab-btn" data-status="APPROVED"       onclick="setTab(this,'APPROVED')">Approved</button>
      <button class="tab-btn" data-status="REJECTED"       onclick="setTab(this,'REJECTED')">Rejected</button>
    </div>
    <div class="md:ml-auto flex gap-2">
      <input id="search-input" class="ifield w-52" placeholder="ğŸ” Search name / mobileâ€¦" oninput="debounceSearch()"/>
      <button onclick="loadCandidates(); loadStats()"
              class="action-btn bg-gray-100 text-gray-600 hover:bg-gray-200 px-4">â†» Refresh</button>
      <button onclick="openInitiate()"
              class="action-btn gbg text-white px-5 py-2 text-sm shadow">+ Initiate Candidate</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-100">
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">#</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Employee</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Mobile</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Designation</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Assigned HR</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Status</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Link</th>
            <th class="text-left px-5 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wide">Actions</th>
          </tr>
        </thead>
        <tbody id="candidates-tbody">
          <tr><td colspan="8" class="text-center py-14 text-gray-400">Loading candidatesâ€¦</td></tr>
        </tbody>
      </table>
    </div>
    <div class="flex items-center justify-between px-5 py-4 border-t border-gray-100">
      <span class="text-xs text-gray-500" id="page-info">â€“</span>
      <div class="flex gap-2">
        <button onclick="prevPage()" id="btn-prev" class="action-btn bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2">â† Prev</button>
        <button onclick="nextPage()" id="btn-next" class="action-btn bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2">Next â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: INITIATE -->
<div class="overlay" id="modal-initiate">
  <div class="card modal-box w-full max-w-lg mx-4 p-7 relative max-h-screen overflow-y-auto">
    <button onclick="closeModal('modal-initiate')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold">âœ•</button>
    <h2 class="text-lg font-bold text-gray-800 mb-5">â• Initiate New Candidate</h2>
    <div class="space-y-4">
      <div>
        <label class="lbl">Employee Name *</label>
        <input class="ifield" id="i-name" placeholder="Full name"/>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="lbl">Mobile *</label>
          <input class="ifield" id="i-mobile" placeholder="10-digit mobile" maxlength="10"/>
        </div>
        <div>
          <label class="lbl">Aadhaar No</label>
          <input class="ifield" id="i-aadhaar" placeholder="12-digit Aadhaar" maxlength="12"/>
        </div>
      </div>
      <div>
        <label class="lbl">Email ID</label>
        <input type="email" class="ifield" id="i-email" placeholder="candidate@email.com"/>
      </div>
      <div>
        <label class="lbl">Designation *</label>
        <input class="ifield" id="i-designation" placeholder="e.g. Sales Executive"/>
      </div>
      <div>
        <label class="lbl">Assign HR</label>
        <select class="ifield" id="i-hr">
          <option value="">Select HR (optional)</option>
        </select>
      </div>
      <div>
        <label class="lbl">Send Link via SMS</label>
        <select class="ifield" id="i-sendlink">
          <option value="true">Yes â€“ Send immediately</option>
          <option value="false">No â€“ Send manually later</option>
        </select>
      </div>
    </div>
    <div id="initiate-error" class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-xl text-sm"></div>
    <div class="flex gap-3 mt-6">
      <button onclick="closeModal('modal-initiate')" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-xl font-semibold hover:bg-gray-200 transition">Cancel</button>
      <button id="submit-initiate" onclick="submitInitiate()" class="flex-1 gbg text-white py-2.5 rounded-xl font-bold hover:opacity-90 transition shadow">Initiate & Send Link</button>
    </div>
  </div>
</div>

<!-- MODAL: DETAIL -->
<div class="overlay" id="modal-detail">
  <div class="card modal-box w-full max-w-2xl mx-4 p-7 relative max-h-[90vh] overflow-y-auto">
    <button onclick="closeModal('modal-detail')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold">âœ•</button>
    <h2 class="text-lg font-bold text-gray-800 mb-5">ğŸ‘¤ Candidate Details</h2>
    <div id="detail-body" class="text-sm text-gray-600 space-y-2"></div>
    <div class="flex gap-3 mt-6" id="detail-actions"></div>
  </div>
</div>

<!-- MODAL: REJECT -->
<div class="overlay" id="modal-reject">
  <div class="card modal-box w-full max-w-md mx-4 p-7 relative">
    <button onclick="closeModal('modal-reject')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold">âœ•</button>
    <h2 class="text-lg font-bold text-gray-800 mb-4">âŒ Reject Candidate</h2>
    <input type="hidden" id="reject-id"/>
    <div>
      <label class="lbl">Rejection Reason *</label>
      <textarea class="ifield" id="reject-reason" rows="4" placeholder="Minimum 10 characters"></textarea>
    </div>
    <div id="reject-error" class="hidden mt-3 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-xl text-xs"></div>
    <div class="flex gap-3 mt-5">
      <button onclick="closeModal('modal-reject')" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-xl font-semibold hover:bg-gray-200">Cancel</button>
      <button onclick="submitReject()" class="flex-1 bg-red-600 text-white py-2.5 rounded-xl font-bold hover:bg-red-700">Confirm Reject</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
  <div class="bg-gray-900 text-white px-5 py-3 rounded-xl shadow-2xl text-sm font-semibold"></div>
</div>

<script>
  const API = (window.API_BASE || "https://rspl-hr-onboarding-backend-production.up.railway.app/api");

  // â”€â”€ Auth Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const HR_TOKEN    = localStorage.getItem("hr_token");
  const HR_NAME     = localStorage.getItem("hr_name")     || "HR User";
  const HR_ROLE     = localStorage.getItem("hr_role")     || "HR";
  const HR_USERNAME = localStorage.getItem("hr_username") || "";

  if (!HR_TOKEN) window.location.href = "login.html";

  document.getElementById("hr-user-name").textContent = HR_NAME;
  document.getElementById("hr-user-role").textContent = HR_ROLE.replace("_", " ");
  document.getElementById("user-avatar").textContent  = HR_NAME.charAt(0).toUpperCase();

  // â”€â”€ authFetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function authFetch(url, options = {}) {
    options.headers = options.headers || {};
    options.headers["Authorization"] = "Bearer " + HR_TOKEN;
    if (!options.headers["Content-Type"] && options.body) {
      options.headers["Content-Type"] = "application/json";
    }
    return fetch(url, options).then(res => {
      if (res.status === 401 || res.status === 403) {
        localStorage.clear();
        window.location.href = "login.html";
        throw new Error("Session expired");
      }
      return res;
    });
  }

  // âœ… FIX 1: Stateless JWT â€” no server logout call needed
  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentPage   = 0;
  let totalPages    = 1;
  let currentStatus = "";
  let searchTerm    = "";
  let searchTimer   = null;
  let hrTeam        = [];

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type = "green") {
    const cols = { green:"#16a34a", red:"#dc2626", blue:"#2563eb" };
    const t = document.getElementById("toast");
    const b = t.querySelector("div");
    b.style.background = cols[type] || cols.green;
    b.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), 3500);
  }

  function badgeClass(status) {
    const map = {
      INITIATED:      "b-initiated",
      FORM_SUBMITTED: "b-form_submitted",
      SIGNED:         "b-signed",
      APPROVED:       "b-approved",
      REJECTED:       "b-rejected"
    };
    return map[status] || "bg-gray-100 text-gray-600";
  }

  function linkBadge(ls) {
    if (ls === "SENT") return '<span class="badge bg-green-100 text-green-700">âœ“ Sent</span>';
    return '<span class="badge bg-gray-100 text-gray-500">Not Sent</span>';
  }

  function openModal(id)  { document.getElementById(id).classList.add("open"); }
  function closeModal(id) { document.getElementById(id).classList.remove("open"); }

  function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      searchTerm  = document.getElementById("search-input").value.trim();
      currentPage = 0;
      loadCandidates();
    }, 400);
  }

  function setTab(el, status) {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    el.classList.add("active");
    currentStatus = status;
    currentPage   = 0;
    loadCandidates();
  }

  function prevPage() { if (currentPage > 0) { currentPage--; loadCandidates(); } }
  function nextPage() { if (currentPage < totalPages - 1) { currentPage++; loadCandidates(); } }

  // â”€â”€ Load Stats (FIX 2: real totals from backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadStats() {
    try {
      const res  = await authFetch(`${API}/hr/candidates/stats`);
      const data = await res.json();
      if (data.success) {
        const s = data.data;
        document.getElementById("stat-total").textContent     = s.total          || 0;
        document.getElementById("stat-initiated").textContent = s.INITIATED       || 0;
        document.getElementById("stat-submitted").textContent = s.FORM_SUBMITTED  || 0;
        document.getElementById("stat-approved").textContent  = s.APPROVED        || 0;
        document.getElementById("stat-rejected").textContent  = s.REJECTED        || 0;
      }
    } catch(e) {}
  }

  // â”€â”€ Load HR Team â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadHRTeam() {
    try {
      const res  = await authFetch(`${API}/hr/team`);
      const data = await res.json();
      if (data.success) {
        hrTeam = data.data;
        const sel = document.getElementById("i-hr");
        hrTeam.forEach(hr => {
          const opt = document.createElement("option");
          opt.value       = hr.id;
          opt.textContent = `${hr.name} (${hr.role})`;
          sel.appendChild(opt);
        });
      }
    } catch(e) {}
  }

  // â”€â”€ Load Candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCandidates() {
    const tbody = document.getElementById("candidates-tbody");
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-12 text-gray-400">Loadingâ€¦</td></tr>`;

    let url = `${API}/hr/candidates?page=${currentPage}&size=15`;
    if (currentStatus) url += `&status=${currentStatus}`;
    if (searchTerm)    url += `&search=${encodeURIComponent(searchTerm)}`;

    try {
      const res  = await authFetch(url);
      const data = await res.json();

      if (!data.success) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-red-400">Failed to load</td></tr>`;
        return;
      }

      const page = data.data;
      totalPages = page.totalPages || 1;

      document.getElementById("page-info").textContent =
        `Showing ${page.content.length} of ${page.totalElements} | Page ${page.page + 1}/${page.totalPages}`;
      document.getElementById("btn-prev").disabled = currentPage === 0;
      document.getElementById("btn-next").disabled = currentPage >= totalPages - 1;

      if (!page.content.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-14 text-gray-400">No candidates found</td></tr>`;
        return;
      }

      tbody.innerHTML = page.content.map((c, i) => `
        <tr class="border-b border-gray-50 cursor-pointer" onclick="viewDetail(${c.id})">
          <td class="px-5 py-3.5 text-gray-400 font-mono text-xs">${currentPage * 15 + i + 1}</td>
          <td class="px-5 py-3.5">
            <div class="font-semibold text-gray-800">${c.employeeName || "â€“"}</div>
            <div class="text-xs text-gray-400">${c.emailId || ""}</div>
          </td>
          <td class="px-5 py-3.5 text-gray-600">${c.mobileNo || "â€“"}</td>
          <td class="px-5 py-3.5 text-gray-600">${c.designation || "â€“"}</td>
          <td class="px-5 py-3.5 text-gray-500 text-xs">${c.assignedHr?.name || "â€“"}</td>
          <td class="px-5 py-3.5">
            <span class="badge ${badgeClass(c.joiningStatus)}">${(c.joiningStatus || "â€“").replace("_", " ")}</span>
          </td>
          <td class="px-5 py-3.5">${linkBadge(c.linkStatus)}</td>
          <td class="px-5 py-3.5" onclick="event.stopPropagation()">
            <div class="flex gap-1.5">
              ${c.joiningStatus === "INITIATED" || c.linkStatus === "NOT_SENT" ? `
                <button onclick="sendLink(${c.id})"
                        class="action-btn bg-blue-50 text-blue-700 hover:bg-blue-100 text-xs px-2 py-1">
                  ğŸ“± Link
                </button>` : ""}
              ${c.joiningStatus === "SIGNED" ? `
                <button onclick="approveCandidate(${c.id})"
                        class="action-btn bg-green-600 text-white hover:bg-green-700 px-3 py-1">âœ“ Approve</button>
                <button onclick="openReject(${c.id})"
                        class="action-btn bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1">âœ• Reject</button>` : ""}
              ${c.joiningStatus === "FORM_SUBMITTED" ? `
                <button onclick="openReject(${c.id})"
                        class="action-btn bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1">âœ• Reject</button>` : ""}
              ${c.joiningStatus === "APPROVED" ? `
                <span class="text-xs text-green-600 font-semibold">âœ“ ${c.employeeId || ""}</span>` : ""}
            </div>
          </td>
        </tr>`).join("");
    } catch(e) {
      if (e.message !== "Session expired") {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-red-400">Error: ${e.message}</td></tr>`;
      }
    }
  }

  // â”€â”€ Initiate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openInitiate() {
    ["i-name","i-mobile","i-aadhaar","i-email","i-designation"].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById("i-hr").value       = "";
    document.getElementById("i-sendlink").value = "true";
    document.getElementById("initiate-error").classList.add("hidden");
    openModal("modal-initiate");
  }

  async function submitInitiate() {
    const name   = document.getElementById("i-name").value.trim();
    const mobile = document.getElementById("i-mobile").value.trim();
    const desig  = document.getElementById("i-designation").value.trim();
    const errEl  = document.getElementById("initiate-error");

    if (!name || !mobile || !desig) {
      errEl.textContent = "âš ï¸ Name, Mobile and Designation are required";
      errEl.classList.remove("hidden");
      return;
    }
    if (!/^[6-9]\d{9}$/.test(mobile)) {
      errEl.textContent = "âš ï¸ Mobile must be 10 digits starting with 6-9";
      errEl.classList.remove("hidden");
      return;
    }

    const btn = document.getElementById("submit-initiate");
    btn.disabled    = true;
    btn.textContent = "Initiatingâ€¦";

    const hrId = document.getElementById("i-hr").value;
    const payload = {
      employeeName:        name,
      mobileNo:            mobile,
      aadhaarNo:           document.getElementById("i-aadhaar").value.trim(),
      emailId:             document.getElementById("i-email").value.trim(),
      designation:         desig,
      assignedHRId:        hrId ? parseInt(hrId) : null,
      initiatedBy:         HR_USERNAME,
      sendLinkImmediately: document.getElementById("i-sendlink").value === "true"
    };

    try {
      const res  = await authFetch(`${API}/hr/candidates/initiate`, {
        method: "POST",
        body:   JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.success) {
        toast("âœ… Candidate initiated successfully!", "green");
        closeModal("modal-initiate");
        loadCandidates();
        loadStats();
      } else {
        errEl.textContent = "âš ï¸ " + (data.message || "Failed to initiate");
        errEl.classList.remove("hidden");
      }
    } catch(e) {
      if (e.message !== "Session expired") {
        errEl.textContent = "âš ï¸ Server error. Try again.";
        errEl.classList.remove("hidden");
      }
    } finally {
      btn.disabled    = false;
      btn.textContent = "Initiate & Send Link";
    }
  }

  // â”€â”€ Send Link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendLink(id) {
    try {
      const res  = await authFetch(`${API}/hr/candidates/${id}/send-link`, { method:"POST" });
      const data = await res.json();
      if (data.success) {
        toast("ğŸ“± Link sent via SMS!", "blue");
        loadCandidates();
      } else {
        toast("âŒ " + (data.message || "Failed"), "red");
      }
    } catch(e) {}
  }

  // â”€â”€ View Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function viewDetail(id) {
    openModal("modal-detail");
    document.getElementById("detail-body").innerHTML    = "<p class='text-gray-400'>Loadingâ€¦</p>";
    document.getElementById("detail-actions").innerHTML = "";

    try {
      const res  = await authFetch(`${API}/hr/candidates/${id}`);
      const data = await res.json();
      if (!data.success) {
        document.getElementById("detail-body").innerHTML = "<p class='text-red-400'>Failed to load</p>";
        return;
      }

      const c = data.data;
      const rows = [
        ["Employee Name", c.employeeName],
        ["Mobile",        c.mobileNo],
        ["Email",         c.emailId || "â€“"],
        ["Designation",   c.designation],
        ["Aadhaar",       c.aadhaarNo || "â€“"],
        ["Status",        `<span class="badge ${badgeClass(c.joiningStatus)}">${(c.joiningStatus||"").replace("_"," ")}</span>`],
        ["Link Status",   linkBadge(c.linkStatus)],
        ["Employee ID",   c.employeeId ? `<strong class="text-green-600">${c.employeeId}</strong>` : "â€“"],
        ["Assigned HR",   c.assignedHr?.name || "â€“"],   // âœ… FIX 4: lowercase 'r'
        ["Initiated By",  c.initiatedBy || "â€“"],
        ["Date",          c.createdAt ? c.createdAt.substring(0,10) : "â€“"],
        ...(c.joiningStatus !== "INITIATED" ? [
          ["Father's Name", c.fathersName || "â€“"],
          ["Date of Birth", c.dob || "â€“"],
          ["Gender",        c.gender || "â€“"],
          ["Blood Group",   c.bloodGroup || "â€“"],
          ["PAN",           c.panCardNo || "â€“"],
          ["Bank",          c.bankName ? `${c.bankName} | A/C: ${c.bankAccountNo} | IFSC: ${c.ifscCode}` : "â€“"],
          ["Nominee",       c.nomineeName ? `${c.nomineeName} (${c.nomineeRelation})` : "â€“"],
          ["Address",       c.permanentAddress ? `${c.permanentAddress}, ${c.district}, ${c.state} â€“ ${c.pinCode}` : "â€“"],
        ] : []),
        ...(c.rejectionReason ? [["Rejection Reason", `<span class="text-red-600">${c.rejectionReason}</span>`]] : [])
      ];

      document.getElementById("detail-body").innerHTML = rows.map(([k,v]) => `
        <div class="flex gap-3 py-1.5 border-b border-gray-50">
          <span class="w-36 flex-shrink-0 text-gray-400 font-semibold text-xs uppercase tracking-wide">${k}</span>
          <span class="text-gray-700">${v || "â€“"}</span>
        </div>`).join("");

      let actions = "";
      if (c.joiningStatus === "SIGNED") {
        actions += `<button onclick="approveCandidate(${c.id})"
          class="flex-1 gbg text-white py-2.5 rounded-xl font-bold hover:opacity-90 shadow">
          âœ“ Approve & Generate Employee ID</button>`;
        actions += `<button onclick="closeModal('modal-detail');openReject(${c.id})"
          class="flex-1 bg-red-600 text-white py-2.5 rounded-xl font-bold hover:bg-red-700">
          âœ• Reject</button>`;
      } else if (c.linkStatus === "NOT_SENT" || c.joiningStatus === "INITIATED") {
        actions += `<button onclick="sendLink(${c.id})"
          class="flex-1 gbg text-white py-2.5 rounded-xl font-bold hover:opacity-90">
          ğŸ“± Send Onboarding Link</button>`;
      }
      document.getElementById("detail-actions").innerHTML = actions;
    } catch(e) {}
  }

  // â”€â”€ Approve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function approveCandidate(id) {
    if (!confirm("Approve this candidate and generate Employee ID?")) return;
    try {
      const res  = await authFetch(`${API}/hr/candidates/${id}/approve`, { method:"POST" });
      const data = await res.json();
      if (data.success) {
        toast("âœ… Approved! Employee ID: " + (data.data?.employeeId || ""), "green");
        closeModal("modal-detail");
        loadCandidates();
        loadStats();
      } else {
        toast("âŒ " + (data.message || "Failed to approve"), "red");
      }
    } catch(e) {}
  }

  // â”€â”€ Reject â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openReject(id) {
    document.getElementById("reject-id").value     = id;
    document.getElementById("reject-reason").value = "";
    document.getElementById("reject-error").classList.add("hidden");
    openModal("modal-reject");
  }

  async function submitReject() {
    const id     = document.getElementById("reject-id").value;
    const reason = document.getElementById("reject-reason").value.trim();
    const errEl  = document.getElementById("reject-error");

    if (reason.length < 10) {
      errEl.textContent = "âš ï¸ Reason must be at least 10 characters";
      errEl.classList.remove("hidden");
      return;
    }

    try {
      const res  = await authFetch(`${API}/hr/candidates/${id}/reject`, {
        method: "POST",
        body:   JSON.stringify({ rejectionReason: reason })  // âœ… FIX 3: correct field name
      });
      const data = await res.json();
      if (data.success) {
        toast("Candidate rejected", "red");
        closeModal("modal-reject");
        closeModal("modal-detail");
        loadCandidates();
        loadStats();
      } else {
        toast("âŒ " + (data.message || "Failed"), "red");
      }
    } catch(e) {}
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadHRTeam();
  loadCandidates();
  loadStats();   // âœ… FIX 2: load real stats on startup

  document.querySelectorAll(".overlay").forEach(el => {
    el.addEventListener("click", e => { if (e.target === el) el.classList.remove("open"); });
  });
</script>
</body>
</html>
