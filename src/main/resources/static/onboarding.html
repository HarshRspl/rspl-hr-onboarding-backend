<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RSPL ‚Äì Candidate Onboarding</title>
  <script src="https://cdn.tailwindcss.comstyle>
    body { font-family: "Segoe UI", system-ui, -apple-system, sans-serif; }
    .brand-gradient { background: linear-gradient(135deg, #0f2d4d 0%, #2563eb 100%); }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.08); }
    .field { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; outline: none; }
    .field:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,.15); }
    .chip { border-radius: 999px; padding: 6px 10px; font-size: 12px; font-weight: 700; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">

  <!-- TOP BAR -->
  <header class="brand-gradient text-white sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-white/15 flex items-center justify-center font-black text-xl">R</div>
      <div class="leading-tight">
        <div class="font-bold text-base">RSPL Health</div>
        <div class="text-xs text-blue-100">Pre‚ÄëOnboarding Portal</div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span id="badge-status" class="chip bg-white/15 text-white hidden"></span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-6 pb-16">

    <!-- LOADING -->
    <section id="scr-loading" class="text-center py-24">
      <div class="inline-flex items-center justify-center w-14 h-14 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <div class="mt-4 text-slate-500 text-sm">Verifying your link‚Ä¶</div>
    </section>

    <!-- INVALID -->
    <section id="scr-invalid" class="hidden">
      <div class="card p-8 md:p-10 text-center">
        <div class="text-6xl mb-4">üîó</div>
        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900">Link Invalid or Expired</h2>
        <p class="mt-2 text-slate-600">This onboarding link is invalid or has expired (valid for 7 days).</p>
        <div class="mt-6 rounded-2xl bg-blue-50 border border-blue-100 p-4 text-left inline-block">
          <div class="text-sm font-bold text-blue-900">Need a new link?</div>
          <div class="text-sm text-blue-800 mt-1">Contact HR: <span class="font-semibold">hr@rspl.com</span></div>
          <div class="text-sm text-blue-800">Phone: <span class="font-semibold">9811001100</span></div>
        </div>
        <div class="mt-8 text-xs text-slate-400">Tip: Ask HR to resend your onboarding link.</div>
      </div>
    </section>

    <!-- ALREADY SUBMITTED -->
    <section id="scr-done" class="hidden">
      <div class="card p-8 md:p-10 text-center">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900">Already Submitted</h2>
        <p class="mt-2 text-slate-600">You have already completed the onboarding form.</p>

        <div id="done-box" class="mt-6"></div>

        <!-- ‚úÖ NEW: Edit button -->
        <div id="edit-actions" class="mt-6 hidden">
          <button onclick="startEdit()"
            class="w-full bg-slate-900 text-white font-extrabold py-3 rounded-xl hover:bg-black">
            Edit Submitted Form ‚úèÔ∏è
          </button>
          <div class="mt-2 text-xs text-slate-500">
            You can edit details until HR signs/approves your onboarding.
          </div>
        </div>

        <div class="mt-8 rounded-2xl bg-emerald-50 border border-emerald-100 p-4 text-emerald-900 text-sm">
          HR is reviewing your details. You‚Äôll be notified soon.
        </div>
      </div>
    </section>

    <!-- WELCOME -->
    <section id="scr-welcome" class="hidden">
      <div class="card p-8 md:p-10">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <div class="text-sm text-slate-500 font-semibold">Welcome</div>
            <div class="text-3xl font-extrabold text-slate-900">
              <span id="w-name">Candidate</span>
            </div>
            <div class="mt-1 text-slate-600 font-medium" id="w-desig"></div>
            <div class="mt-4 text-sm text-slate-500">
              Please complete your joining details. Estimated time: <span class="font-semibold">10‚Äì15 minutes</span>.
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
              <span class="chip bg-amber-50 text-amber-800 border border-amber-100">Keep Aadhaar + PAN handy</span>
              <span class="chip bg-amber-50 text-amber-800 border border-amber-100">Bank proof + nominee details</span>
              <span class="chip bg-amber-50 text-amber-800 border border-amber-100">Education & employment docs</span>
            </div>
          </div>

          <div class="md:w-[280px] rounded-2xl bg-slate-50 border border-slate-200 p-4">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wide">Status</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="w-2.5 h-2.5 rounded-full bg-blue-600"></div>
              <div class="text-sm font-semibold text-slate-800" id="w-status">INITIATED</div>
            </div>

            <button onclick="openWizard()"
              class="mt-4 w-full brand-gradient text-white font-bold py-3 rounded-xl hover:opacity-95 transition">
              Start Onboarding ‚Üí
            </button>

            <div class="mt-3 text-xs text-slate-500">If you face issues, contact HR.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- WIZARD -->
    <section id="scr-wizard" class="hidden">
      <div class="grid md:grid-cols-12 gap-6">

        <!-- LEFT STEPPER -->
        <aside class="md:col-span-4">
          <div class="card p-5 sticky top-[92px]">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wide">Progress</div>
            <div class="mt-3">
              <div class="flex justify-between text-xs text-slate-500 mb-1">
                <span>Completion</span>
                <span id="pct">0%</span>
              </div>
              <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="bar" class="h-2 bg-blue-600 rounded-full" style="width:0%"></div>
              </div>
            </div>

            <div class="mt-6 space-y-2 text-sm">
              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-1" onclick="goStep(1)">
                <div class="font-bold text-slate-800">1) Personal</div>
                <div class="text-xs text-slate-500">Basic details + PF/UAN</div>
              </button>

              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-2" onclick="goStep(2)">
                <div class="font-bold text-slate-800">2) Address</div>
                <div class="text-xs text-slate-500">Permanent address</div>
              </button>

              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-3" onclick="goStep(3)">
                <div class="font-bold text-slate-800">3) Bank</div>
                <div class="text-xs text-slate-500">Account + IFSC</div>
              </button>

              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-4" onclick="goStep(4)">
                <div class="font-bold text-slate-800">4) Nominee</div>
                <div class="text-xs text-slate-500">EPF / Gratuity nominee</div>
              </button>

              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-5" onclick="goStep(5)">
                <div class="font-bold text-slate-800">5) Documents</div>
                <div class="text-xs text-slate-500">Upload documents</div>
              </button>

              <button class="w-full text-left p-3 rounded-xl border bg-white hover:bg-slate-50 transition"
                      id="stepbtn-6" onclick="goStep(6)">
                <div class="font-bold text-slate-800">6) Review & Submit</div>
                <div class="text-xs text-slate-500">Confirm & submit</div>
              </button>
            </div>

            <div class="mt-6 text-xs text-slate-500">üîí Your data is securely submitted to HR.</div>
          </div>
        </aside>

        <!-- RIGHT CONTENT -->
        <section class="md:col-span-8 space-y-6">

          <!-- Error area -->
          <div id="err" class="hidden rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800"></div>

          <!-- STEP 1 -->
          <div id="step-1" class="card p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Personal Information</h2>
                <p class="text-sm text-slate-500 mt-1">Fill basic details. Fields marked * are mandatory.</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 1/6</span>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
                <input id="f-name" class="field bg-slate-50 text-slate-600" readonly />
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Father‚Äôs Name *</label>
                <input id="f-fathers-name" class="field" placeholder="Father's full name"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Date of Birth *</label>
                <input id="f-dob" type="date" class="field"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Gender *</label>
                <select id="f-gender" class="field">
                  <option value="">Select</option>
                  <option>Male</option><option>Female</option><option>Other</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Marital Status *</label>
                <select id="f-marital" class="field">
                  <option value="">Select</option>
                  <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Blood Group *</label>
                <select id="f-blood" class="field">
                  <option value="">Select</option>
                  <option>A+</option><option>A-</option>
                  <option>B+</option><option>B-</option>
                  <option>AB+</option><option>AB-</option>
                  <option>O+</option><option>O-</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Highest Education *</label>
                <select id="f-education" class="field">
                  <option value="">Select</option>
                  <option>10th Pass</option><option>12th Pass</option><option>Diploma</option>
                  <option>Graduate (B.A / B.Sc / B.Com)</option>
                  <option>Graduate (B.Tech / B.E)</option>
                  <option>Post Graduate</option><option>MBA</option><option>PhD</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">PAN Number *</label>
                <input id="f-pan" class="field" maxlength="10" placeholder="ABCDE1234F" style="text-transform:uppercase"/>
                <div class="text-[11px] text-slate-400 mt-1">Format: 5 letters + 4 digits + 1 letter</div>
              </div>
            </div>

            <!-- UAN SECTION -->
            <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50 p-5">
              <div class="flex items-center justify-between">
                <div class="font-extrabold text-slate-900">PF / UAN</div>
                <span class="text-xs text-slate-500 font-semibold">Optional if you don‚Äôt have UAN yet</span>
              </div>

              <div class="mt-3 text-sm font-semibold text-slate-700">Do you already have UAN?</div>
              <div class="mt-2 flex gap-6">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="uanAvailable" value="YES" onchange="toggleUan()" />
                  <span class="text-sm">Yes</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="uanAvailable" value="NO" onchange="toggleUan()" checked />
                  <span class="text-sm">No</span>
                </label>
              </div>

              <div id="uan-yes" class="hidden mt-4">
                <label class="text-xs font-bold text-slate-500 uppercase">UAN Number (12 digits)</label>
                <input id="f-uan" class="field" maxlength="12" placeholder="Enter 12-digit UAN"
                       oninput="this.value=this.value.replace(/\D/g,'')"/>
              </div>

              <div id="uan-no" class="mt-4">
                <div class="rounded-xl bg-blue-50 border border-blue-100 p-4">
                  <div class="text-sm font-bold text-blue-900">No UAN? Generate & activate easily</div>
                  <div class="text-xs text-blue-800 mt-1">Watch the Official EPFO guide video.</div>
                  https://www.youtube.com/watch?v=vw3k-w_3g1I
                    ‚ñ∂ Official EPFO UAN Guide (YouTube)
                  </a>
                </div>
              </div>
            </div>

            <div class="mt-6 flex justify-end">
              <button onclick="nextStep()" class="brand-gradient text-white font-bold px-6 py-3 rounded-xl hover:opacity-95">
                Next ‚Üí
              </button>
            </div>
          </div>

          <!-- STEP 2 -->
          <div id="step-2" class="card p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Address Details</h2>
                <p class="text-sm text-slate-500 mt-1">Enter your permanent address details.</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 2/6</span>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Permanent Address *</label>
                <textarea id="f-address" class="field" rows="3" placeholder="House No, Street, Area, Landmark"></textarea>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">District *</label>
                <input id="f-district" class="field" placeholder="District"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">State *</label>
                <input id="f-state" class="field" placeholder="State"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">PIN Code *</label>
                <input id="f-pin" class="field" maxlength="6" placeholder="6-digit PIN"
                       oninput="this.value=this.value.replace(/\D/g,'')"/>
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button onclick="prevStep()" class="px-6 py-3 rounded-xl font-bold border hover:bg-slate-50">‚Üê Back</button>
              <button onclick="nextStep()" class="brand-gradient text-white font-bold px-6 py-3 rounded-xl hover:opacity-95">Next ‚Üí</button>
            </div>
          </div>

          <!-- STEP 3 -->
          <div id="step-3" class="card p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Bank Details</h2>
                <p class="text-sm text-slate-500 mt-1">Enter bank details for salary processing.</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 3/6</span>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Bank Name *</label>
                <input id="f-bank-name" class="field" placeholder="Bank name"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Account Number *</label>
                <input id="f-account" class="field" maxlength="20" placeholder="Account number"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">IFSC Code *</label>
                <input id="f-ifsc" class="field" maxlength="11" placeholder="SBIN0001234" style="text-transform:uppercase"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Branch Name *</label>
                <input id="f-branch" class="field" placeholder="Branch name"/>
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button onclick="prevStep()" class="px-6 py-3 rounded-xl font-bold border hover:bg-slate-50">‚Üê Back</button>
              <button onclick="nextStep()" class="brand-gradient text-white font-bold px-6 py-3 rounded-xl hover:opacity-95">Next ‚Üí</button>
            </div>
          </div>

          <!-- STEP 4 -->
          <div id="step-4" class="card p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Nominee Details</h2>
                <p class="text-sm text-slate-500 mt-1">Nominee required for EPF/Gratuity.</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 4/6</span>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Nominee Name *</label>
                <input id="f-nominee-name" class="field" placeholder="Nominee full name"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Relation *</label>
                <select id="f-nominee-relation" class="field">
                  <option value="">Select</option>
                  <option>Father</option><option>Mother</option><option>Spouse</option>
                  <option>Son</option><option>Daughter</option>
                  <option>Brother</option><option>Sister</option><option>Other</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Nominee Date of Birth *</label>
                <input id="f-nominee-dob" type="date" class="field"/>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Nominee Address *</label>
                <input id="f-nominee-address" class="field" placeholder="Nominee address"/>
              </div>
            </div>

            <div class="mt-6 flex justify-between">
              <button onclick="prevStep()" class="px-6 py-3 rounded-xl font-bold border hover:bg-slate-50">‚Üê Back</button>
              <button onclick="nextStep()" class="brand-gradient text-white font-bold px-6 py-3 rounded-xl hover:opacity-95">Next ‚Üí</button>
            </div>
          </div>

          <!-- STEP 5: DOCUMENTS -->
          <div id="step-5" class="card p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Upload Documents</h2>
                <p class="text-sm text-slate-500 mt-1">PDF/JPG/PNG allowed (max 5MB each).</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 5/6</span>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div class="rounded-2xl border p-4">
                <div class="font-bold text-slate-800">Aadhaar</div>
                <div class="text-xs text-slate-500 mt-1">PDF/JPG/PNG</div>
                <input id="doc-aadhaar" type="file" accept=".pdf,.jpg,.jpeg,.png" class="mt-3 w-full"/>
                <button type="button" onclick="uploadDoc('AADHAAR','doc-aadhaar')"
                        class="mt-3 w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700">
                  Upload Aadhaar
                </button>
              </div>

              <div class="rounded-2xl border p-4">
                <div class="font-bold text-slate-800">PAN</div>
                <div class="text-xs text-slate-500 mt-1">PDF/JPG/PNG</div>
                <input id="doc-pan" type="file" accept=".pdf,.jpg,.jpeg,.png" class="mt-3 w-full"/>
                <button type="button" onclick="uploadDoc('PAN','doc-pan')"
                        class="mt-3 w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700">
                  Upload PAN
                </button>
              </div>

              <div class="rounded-2xl border p-4">
                <div class="font-bold text-slate-800">Bank Proof</div>
                <div class="text-xs text-slate-500 mt-1">Cancelled cheque / passbook</div>
                <input id="doc-bank" type="file" accept=".pdf,.jpg,.jpeg,.png" class="mt-3 w-full"/>
                <button type="button" onclick="uploadDoc('BANK_PROOF','doc-bank')"
                        class="mt-3 w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700">
                  Upload Bank Proof
                </button>
              </div>

              <div class="rounded-2xl border p-4">
                <div class="font-bold text-slate-800">Photo</div>
                <div class="text-xs text-slate-500 mt-1">JPG/PNG</div>
                <input id="doc-photo" type="file" accept=".jpg,.jpeg,.png" class="mt-3 w-full"/>
                <button type="button" onclick="uploadDoc('PHOTO','doc-photo')"
                        class="mt-3 w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700">
                  Upload Photo
                </button>
              </div>
            </div>

            <!-- Tabs for Education vs Employment -->
            <div class="mt-5 rounded-2xl border p-4">
              <div class="flex items-center justify-between gap-4 flex-wrap">
                <div>
                  <div class="font-extrabold text-slate-900">Education & Employment Documents</div>
                  <div class="text-xs text-slate-500 mt-1">Multiple files allowed (PDF/JPG/PNG)</div>
                </div>

                <div class="inline-flex rounded-xl bg-slate-100 p-1">
                  <button type="button" id="tab-edu"
                          onclick="setDocTab('edu')"
                          class="px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-900 shadow-sm">
                    Education
                  </button>

                  <button type="button" id="tab-exp"
                          onclick="setDocTab('emp')"
                          class="px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-900">
                    Employment
                  </button>
                </div>
              </div>

              <!-- Education Panel -->
              <div id="panel-edu" class="mt-4">
                <div class="rounded-xl bg-indigo-50 border border-indigo-100 p-4">
                  <div class="font-bold text-indigo-900">Education Documents (Multiple)</div>
                  <div class="text-xs text-indigo-800 mt-1">
                    Examples: 10th/12th marksheet, graduation degree, diploma certificate, etc.
                  </div>
                  <input id="doc-education" type="file" multiple accept=".pdf,.jpg,.jpeg,.png" class="mt-3 w-full"/>
                  <button type="button" onclick="uploadMultiple('EDUCATION','doc-education')"
                          class="mt-3 w-full bg-indigo-600 text-white font-bold py-2.5 rounded-xl hover:bg-indigo-700">
                    Upload Education Documents
                  </button>
                </div>
              </div>

              <!-- Employment Panel -->
              <div id="panel-emp" class="mt-4 hidden">
                <div class="rounded-xl bg-emerald-50 border border-emerald-100 p-4">
                  <div class="font-bold text-emerald-900">Employment Documents (Multiple)</div>
                  <div class="text-xs text-emerald-800 mt-1">
                    Examples: offer letter, relieving letter, experience letter, salary slips, Form‚Äë16, etc.
                  </div>
                  <input id="doc-employment" type="file" multiple accept=".pdf,.jpg,.jpeg,.png" class="mt-3 w-full"/>
                  <button type="button" onclick="uploadMultiple('EMPLOYMENT','doc-employment')"
                          class="mt-3 w-full bg-emerald-600 text-white font-bold py-2.5 rounded-xl hover:bg-emerald-700">
                    Upload Employment Documents
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2">
              <button type="button" onclick="loadDocs()"
                      class="bg-slate-900 text-white font-bold px-4 py-2.5 rounded-xl hover:bg-black">
                Refresh Uploaded List
              </button>
              <span class="text-xs text-slate-500">Uploaded docs will appear below</span>
            </div>

            <div id="docs-list" class="mt-4 text-sm text-slate-700"></div>

            <div class="mt-6 flex justify-between">
              <button onclick="prevStep()" class="px-6 py-3 rounded-xl font-bold border hover:bg-slate-50">‚Üê Back</button>
              <button onclick="nextStep()" class="brand-gradient text-white font-bold px-6 py-3 rounded-xl hover:opacity-95">Next ‚Üí</button>
            </div>
          </div>

          <!-- STEP 6 -->
          <div id="step-6" class="card p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-extrabold text-slate-900">Review & Submit</h2>
                <p class="text-sm text-slate-500 mt-1">Confirm details and submit.</p>
              </div>
              <span class="chip bg-blue-50 text-blue-700 border border-blue-100">Step 6/6</span>
            </div>

            <div class="mt-6 rounded-2xl border bg-slate-50 p-5">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="f-consent" class="mt-1 w-4 h-4"/>
                <span class="text-sm text-slate-700">
                  I declare that the details provided are true and correct. I consent to processing of my data for employment purposes.
                </span>
              </label>
            </div>

            <div class="mt-6 flex justify-between">
              <button onclick="prevStep()" class="px-6 py-3 rounded-xl font-bold border hover:bg-slate-50">‚Üê Back</button>
              <button id="btn-submit" onclick="submitForm()"
                      class="brand-gradient text-white font-extrabold px-6 py-3 rounded-xl hover:opacity-95">
                Submit Form ‚úÖ
              </button>
            </div>

            <div class="mt-3 text-xs text-slate-500">After submission, HR will review and update your status.</div>
          </div>

        </section>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 hidden z-50">
    <div id="toast-box" class="bg-slate-900 text-white px-5 py-3 rounded-xl shadow-2xl text-sm font-bold"></div>
  </div>

<script>
  const API = "https://rspl-hr-onboarding-backend-production.up.railway.app/api";
  let TOKEN = null;
  let CAND = null;
  let STEP = 1;

  // ‚úÖ NEW: mode tracking
  let MODE = "new"; // "new" | "edit"

  function qs(k){ return new URLSearchParams(location.search).get(k); }

  function toast(msg){
    const t = document.getElementById("toast");
    const box = document.getElementById("toast-box");
    box.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(()=>t.classList.add("hidden"), 2800);
  }

  function show(id){
    ["scr-loading","scr-invalid","scr-welcome","scr-wizard","scr-done"].forEach(x=>{
      const el=document.getElementById(x);
      if(el) el.classList.add("hidden");
    });
    document.getElementById(id).classList.remove("hidden");
  }

  function setErr(msg){
    const e = document.getElementById("err");
    e.textContent = "‚ö† " + msg;
    e.classList.remove("hidden");
    e.scrollIntoView({behavior:"smooth", block:"center"});
    setTimeout(()=>e.classList.add("hidden"), 5000);
  }

  function toggleUan(){
    const v = document.querySelector('input[name="uanAvailable"]:checked')?.value || "NO";
    const yes = document.getElementById("uan-yes");
    const no = document.getElementById("uan-no");
    if(v==="YES"){ yes.classList.remove("hidden"); no.classList.add("hidden"); }
    else { yes.classList.add("hidden"); no.classList.remove("hidden"); const u=document.getElementById("f-uan"); if(u) u.value=""; }
    updateProgress();
  }

  // ‚úÖ Tabs: Education vs Employment
  function setDocTab(tab){
    const tabEdu = document.getElementById("tab-edu");
    const tabEmp = document.getElementById("tab-exp");
    const panelEdu = document.getElementById("panel-edu");
    const panelEmp = document.getElementById("panel-emp");

    if(tab === "edu"){
      tabEdu.className = "px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-900 shadow-sm";
      tabEmp.className = "px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-900";
      panelEdu.classList.remove("hidden");
      panelEmp.classList.add("hidden");
    } else {
      tabEmp.className = "px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-900 shadow-sm";
      tabEdu.className = "px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-900";
      panelEmp.classList.remove("hidden");
      panelEdu.classList.add("hidden");
    }
  }

  function openWizard(){
    MODE = "new";
    const btn = document.getElementById("btn-submit");
    if(btn) btn.textContent = "Submit Form ‚úÖ";
    show("scr-wizard");
    goStep(1);
  }

  function goStep(n){
    STEP=n;
    for(let i=1;i<=6;i++){
      document.getElementById(`step-${i}`).classList.toggle("hidden", i!==n);
      document.getElementById(`stepbtn-${i}`).classList.toggle("bg-slate-50", i===n);
      document.getElementById(`stepbtn-${i}`).classList.toggle("border-blue-200", i===n);
    }
    updateProgress();
    window.scrollTo({top: 0, behavior: "smooth"});
  }

  function nextStep(){
    if(!validateStep(STEP)) return;
    goStep(Math.min(6, STEP+1));
  }

  function prevStep(){ goStep(Math.max(1, STEP-1)); }

  function updateProgress(){
    const ids = [
      "f-fathers-name","f-dob","f-gender","f-marital","f-blood","f-education","f-pan",
      "f-address","f-district","f-state","f-pin",
      "f-bank-name","f-account","f-ifsc","f-branch",
      "f-nominee-name","f-nominee-relation","f-nominee-dob","f-nominee-address"
    ];

    const uanYes = document.querySelector('input[name="uanAvailable"]:checked')?.value === "YES";
    if(uanYes) ids.push("f-uan");

    const filled = ids.filter(id => (document.getElementById(id)?.value || "").trim() !== "").length;
    const total = ids.length + 1; // + consent
    const consent = document.getElementById("f-consent")?.checked ? 1 : 0;
    const pct = Math.round(((filled + consent) / total) * 100);

    document.getElementById("pct").textContent = pct + "%";
    document.getElementById("bar").style.width = pct + "%";
  }

  function validateStep(step){
    const req = {
      1: [
        ["f-fathers-name","Father‚Äôs Name"],
        ["f-dob","Date of Birth"],
        ["f-gender","Gender"],
        ["f-marital","Marital Status"],
        ["f-blood","Blood Group"],
        ["f-education","Highest Education"],
        ["f-pan","PAN Number"]
      ],
      2: [["f-address","Permanent Address"],["f-district","District"],["f-state","State"],["f-pin","PIN Code"]],
      3: [["f-bank-name","Bank Name"],["f-account","Account Number"],["f-ifsc","IFSC Code"],["f-branch","Branch Name"]],
      4: [["f-nominee-name","Nominee Name"],["f-nominee-relation","Nominee Relation"],["f-nominee-dob","Nominee DOB"],["f-nominee-address","Nominee Address"]],
      5: [],
      6: []
    };

    const checks = req[step] || [];
    for(const [id,label] of checks){
      const v = (document.getElementById(id)?.value || "").trim();
      if(!v){ setErr(`Please fill: ${label}`); return false; }
    }

    if(step===1){
      const pan = (document.getElementById("f-pan").value || "").toUpperCase();
      if(!/^[A-Z]{5}[0-9]{4}[A-Z]$/.test(pan)){ setErr("Invalid PAN format. Expected ABCDE1234F"); return false; }
      const uanYes = document.querySelector('input[name="uanAvailable"]:checked')?.value === "YES";
      if(uanYes){
        const uan = (document.getElementById("f-uan").value || "").trim();
        if(!/^[0-9]{12}$/.test(uan)){ setErr("UAN must be exactly 12 digits"); return false; }
      }
    }

    if(step===2){
      const pin = (document.getElementById("f-pin").value || "").trim();
      if(!/^[0-9]{6}$/.test(pin)){ setErr("PIN must be exactly 6 digits"); return false; }
    }

    if(step===3){
      const ifsc = (document.getElementById("f-ifsc").value || "").toUpperCase();
      if(!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(ifsc)){ setErr("Invalid IFSC format. Expected SBIN0001234"); return false; }
    }

    return true;
  }

  // ‚úÖ NEW: Prefill helper for Edit mode
  function fillForm(d){
    document.getElementById("f-fathers-name").value = d.fathersName || "";
    document.getElementById("f-dob").value = d.dob || "";
    document.getElementById("f-gender").value = d.gender || "";
    document.getElementById("f-marital").value = d.maritalStatus || "";
    document.getElementById("f-blood").value = d.bloodGroup || "";
    document.getElementById("f-education").value = d.higherEducation || "";
    document.getElementById("f-pan").value = (d.panCardNo || "").toUpperCase();

    const uan = (d.uanAvailable || "NO").toUpperCase();
    const yesRadio = document.querySelector('input[name="uanAvailable"][value="YES"]');
    const noRadio  = document.querySelector('input[name="uanAvailable"][value="NO"]');
    if(uan === "YES") { if(yesRadio) yesRadio.checked = true; }
    else { if(noRadio) noRadio.checked = true; }
    toggleUan();
    const u = document.getElementById("f-uan");
    if(u) u.value = d.uanNo || "";

    document.getElementById("f-address").value = d.permanentAddress || "";
    document.getElementById("f-district").value = d.district || "";
    document.getElementById("f-state").value = d.state || "";
    document.getElementById("f-pin").value = d.pinCode || "";

    document.getElementById("f-bank-name").value = d.bankName || "";
    document.getElementById("f-account").value = d.bankAccountNo || "";
    document.getElementById("f-ifsc").value = (d.ifscCode || "").toUpperCase();
    document.getElementById("f-branch").value = d.branchName || "";

    document.getElementById("f-nominee-name").value = d.nomineeName || "";
    document.getElementById("f-nominee-relation").value = d.nomineeRelation || "";
    document.getElementById("f-nominee-dob").value = d.nomineeDob || "";
    document.getElementById("f-nominee-address").value = d.nomineeAddress || "";

    updateProgress();
  }

  // ‚úÖ NEW: Edit flow
  async function startEdit(){
    MODE = "edit";
    show("scr-wizard");
    goStep(1);

    const btn = document.getElementById("btn-submit");
    if(btn) btn.textContent = "Update Form ‚úèÔ∏è";

    try{
      const res = await fetch(`${API}/candidate/details?token=${TOKEN}`);
      const data = await res.json();
      if(!data.success){
        setErr(data.message || "Unable to load details");
        return;
      }
      fillForm(data.data || {});
      toast("Loaded your submitted details");
    } catch(e){
      setErr("Error loading details: " + e.message);
    }
  }

  async function submitForm(){
    if(!validateStep(1) || !validateStep(2) || !validateStep(3) || !validateStep(4)){
      toast("Please complete required fields");
      return;
    }

    if(!document.getElementById("f-consent").checked){
      setErr("Please accept consent to submit");
      return;
    }

    const uanAvailable = document.querySelector('input[name="uanAvailable"]:checked')?.value || "NO";
    const uanNo = (uanAvailable === "YES") ? (document.getElementById("f-uan").value || "").trim() : "";

    const payload = {
      token: TOKEN,
      fathersName: document.getElementById("f-fathers-name").value.trim(),
      dob: document.getElementById("f-dob").value,
      gender: document.getElementById("f-gender").value,
      maritalStatus: document.getElementById("f-marital").value,
      bloodGroup: document.getElementById("f-blood").value,
      higherEducation: document.getElementById("f-education").value,
      panCardNo: document.getElementById("f-pan").value.toUpperCase(),
      uanAvailable,
      uanNo,
      permanentAddress: document.getElementById("f-address").value.trim(),
      district: document.getElementById("f-district").value.trim(),
      state: document.getElementById("f-state").value.trim(),
      pinCode: document.getElementById("f-pin").value.trim(),
      bankName: document.getElementById("f-bank-name").value.trim(),
      bankAccountNo: document.getElementById("f-account").value.trim(),
      ifscCode: document.getElementById("f-ifsc").value.toUpperCase(),
      branchName: document.getElementById("f-branch").value.trim(),
      nomineeName: document.getElementById("f-nominee-name").value.trim(),
      nomineeRelation: document.getElementById("f-nominee-relation").value,
      nomineeDob: document.getElementById("f-nominee-dob").value,
      nomineeAddress: document.getElementById("f-nominee-address").value.trim()
    };

    const btn = document.getElementById("btn-submit");
    btn.disabled = true;
    btn.textContent = (MODE === "edit") ? "Updating‚Ä¶" : "Submitting‚Ä¶";

    try{
      const endpoint = (MODE === "edit")
        ? `${API}/candidate/update-form`
        : `${API}/candidate/submit-form`;

      const res = await fetch(endpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if(data.success){
        toast(MODE === "edit" ? "Updated successfully ‚úèÔ∏è" : "Submitted successfully ‚úÖ");
        location.reload();
      } else {
        setErr(data.message || "Submission failed");
        btn.disabled = false;
        btn.textContent = (MODE === "edit") ? "Update Form ‚úèÔ∏è" : "Submit Form ‚úÖ";
      }
    } catch(e){
      setErr("Network error: " + e.message);
      btn.disabled = false;
      btn.textContent = (MODE === "edit") ? "Update Form ‚úèÔ∏è" : "Submit Form ‚úÖ";
    }
  }

  async function uploadDoc(docType, inputId){
    const fi = document.getElementById(inputId);
    if(!fi || !fi.files || fi.files.length===0){ toast("Choose a file first"); return; }

    const f = fi.files[0];
    const fd = new FormData();
    fd.append("token", TOKEN);
    fd.append("docType", docType);
    fd.append("file", f);

    try{
      const res = await fetch(`${API}/candidate/documents/upload`, { method:"POST", body: fd });
      const data = await res.json();
      if(data.success){
        toast(`${docType} uploaded`);
        fi.value = "";
        await loadDocs();
      } else {
        setErr(data.message || "Upload failed");
      }
    } catch(e){
      setErr("Upload error: " + e.message);
    }
  }

  async function uploadMultiple(docType, inputId){
    const fi = document.getElementById(inputId);
    if(!fi || !fi.files || fi.files.length===0){ toast("Choose files first"); return; }

    try{
      for(const f of fi.files){
        const fd = new FormData();
        fd.append("token", TOKEN);
        fd.append("docType", docType);
        fd.append("file", f);

        const res = await fetch(`${API}/candidate/documents/upload`, { method:"POST", body: fd });
        const data = await res.json();
        if(!data.success){
          setErr(`Upload failed for ${f.name}: ${data.message || "Error"}`);
          return;
        }
      }
      toast(docType === "EDUCATION" ? "Education documents uploaded ‚úÖ" : "Employment documents uploaded ‚úÖ");
      fi.value = "";
      await loadDocs();
    } catch(e){
      setErr("Upload error: " + e.message);
    }
  }

  async function loadDocs(){
    try{
      const res = await fetch(`${API}/candidate/documents/list?token=${TOKEN}`);
      const data = await res.json();
      if(!data.success){
        document.getElementById("docs-list").innerHTML = "Unable to load documents";
        return;
      }

      const docs = data.data || [];
      const groups = { AADHAAR:[], PAN:[], BANK_PROOF:[], PHOTO:[], EDUCATION:[], EMPLOYMENT:[] };

      docs.forEach(d=>{
        const k = (d.docType || "").toUpperCase();
        const key = (k === "EXPERIENCE") ? "EMPLOYMENT" : k; // backward compatibility
        if(!groups[key]) groups[key] = [];
        groups[key].push(d);
      });

      const renderGroup = (title, items) => {
        if(!items || items.length === 0) return "";
        return `
          <div class="mt-4">
            <div class="text-sm font-extrabold text-slate-900 mb-2">${title}</div>
            ${items.map(d=>`
              <div class="flex items-center justify-between rounded-xl border bg-white px-4 py-3 mb-2">
                <div>
                  <div class="font-bold text-slate-800">${d.originalName}</div>
                  <div class="text-xs text-slate-500">${Math.round((d.fileSize||0)/1024)} KB ‚Ä¢ ${d.uploadedAt || ""}</div>
                </div>
                <a class="text-blue-700 font-bold text-sm underline"
                   href="${API}/candidate/documents/download/${d.id}" target="_blank">Download</a>
              </div>
           aar", groups.AADHAAR) +
        renderGroup("PAN", groups.PAN) +
        renderGroup("Bank Proof", groups.BANK_PROOF) +
        renderGroup("Photo", groups.PHOTO) +
        renderGroup("Education Documents", groups.EDUCATION) +
        renderGroup("Employment Documents", groups.EMPLOYMENT);

      document.getElementById("docs-list").innerHTML =
        html || "<div class='text-slate-500'>No documents uploaded yet.</div>";

    } catch(e){
      document.getElementById("docs-list").innerHTML = "Error: " + e.message;
    }
  }

  async function init(){
    TOKEN = qs("token");
    if(!TOKEN){ show("scr-invalid"); return; }

    try{
      const res = await fetch(`${API}/candidate/verify-token?token=${TOKEN}`);
      const data = await res.json();
      if(!data.success){ show("scr-invalid"); return; }

      CAND = data.data;

      document.getElementById("w-name").textContent = CAND.employeeName || "Candidate";
      document.getElementById("w-desig").textContent = CAND.designation || "";
      document.getElementById("w-status").textContent = CAND.joiningStatus || "INITIATED";

      const badge = document.getElementById("badge-status");
      badge.textContent = (CAND.joiningStatus || "INITIATED").replaceAll("_"," ");
      badge.classList.remove("hidden");

      document.getElementById("f-name").value = CAND.employeeName || "";

      const done = ["FORM_SUBMITTED","SIGNED","APPROVED","REJECTED"];
      if(done.includes((CAND.joiningStatus || "").toUpperCase())){
        show("scr-done");

        // ‚úÖ show Edit only when allowed
        const canEdit = ["FORM_SUBMITTED","REJECTED"].includes((CAND.joiningStatus || "").toUpperCase());
        if(canEdit){
          document.getElementById("edit-actions").classList.remove("hidden");
        }

        try{
          const sr = await fetch(`${API}/candidate/status?token=${TOKEN}`);
          const sd = await sr.json();
          if(sd.success){
            const s = sd.data;
            document.getElementById("done-box").innerHTML = `
              <div class="inline-block chip bg-slate-100 text-slate-700 border">${(s.status||"").replaceAll("_"," ")}</div>
              ${s.employeeId ? `<div class="mt-3 text-lg font-extrabold text-emerald-700">Employee ID: ${s.employeeId}</div>` : ""}
              ${s.rejectionReason ? `<div class="mt-3 text-sm text-red-700">Reason: ${s.rejectionReason}</div>` : ""}
            `;
          }
        } catch(e){}

        return;
      }

      show("scr-welcome");
    } catch(e){
      show("scr-invalid");
    }
  }

  // set DOB max (18 years)
  const mx = new Date(); mx.setFullYear(mx.getFullYear()-18);

  document.addEventListener("DOMContentLoaded", ()=>{
    const dob = document.getElementById("f-dob");
    if(dob) dob.max = mx.toISOString().split("T")[0];

    document.addEventListener("input", updateProgress);
    document.addEventListener("change", updateProgress);
  });

  init();
</script>

</body>
</html>
